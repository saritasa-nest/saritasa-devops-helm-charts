{{ if .Values.apps }}
{{- range $project := .Values.apps }}

{{- if $project.enabled }}
{{- range $component := $project.components }}
{{- $data := dict "project"           $project
                  "component"         $component
                  "environment"       $.Values.environment }}


{{- /* initialize `argocd` variable with either `$component.argocd` dict if it exists or with empty dict */}}
{{ $argocd := ternary $component.argocd dict (hasKey $component "argocd") -}}

{{- /* initialize `argocdSource` variable with either `$argocd.source` dict if it exists or with empty dict */}}
{{ $argocdSource := ternary $argocd.source dict (hasKey $argocd "source") -}}

# ========================================================================
# ðŸŒ± {{ $project.project | upper }}/{{ $component.name | upper }} COMPONENT TRIGGER BINDING
# ========================================================================
apiVersion: triggers.tekton.dev/v1alpha1
kind: TriggerBinding
metadata:
  name:  {{ include "tekton-apps.resourceName" $data }}-env
  namespace: {{ $.Release.Namespace }}
spec:
  params:
  - name: application
    value: {{ include "tekton-apps.resourceName" $data }}
  - name: environment
    value: {{ $.Values.environment }}
  {{- if $.Values.defaultRegistry }}
  - name: docker_registry
    value: {{ $.Values.defaultRegistry }}
  {{- end }}
  {{- toYaml $component.triggerBinding | nindent 2 }}
  {{- if $argocdSource }}
  - name: kubernetes_repository_ssh_url
    value: {{ $argocdSource.repoUrl }}
  - name: kubernetes_branch
    value: {{ $argocdSource.targetRevision | default "main" }}
  - name: kubernetes_repository_kustomize_path
    value: {{ $argocdSource.path | default (printf "apps/%s/manifests/%s" $component.name $.Values.environment) }}
  {{- else }}
  - name: kubernetes_repository_ssh_url
    value: {{ $project.kubernetesRepository.url }}
  {{- include "tekton-apps.get-triggerbinding-value-or-default" (dict "triggerBinding" $component.triggerBinding "name" "kubernetes_branch" "default" "main" ) | nindent 2 }}
  {{- include "tekton-apps.get-triggerbinding-value-or-default" (dict "triggerBinding" $component.triggerBinding "name" "kubernetes_repository_kustomize_path" "default" (printf "apps/%s/manifests/%s" $component.name $.Values.environment) ) | nindent 2 }}
  {{- end }}
  {{- include "tekton-apps.get-triggerbinding-value-or-default" (dict "triggerBinding" $component.triggerBinding "name" "source_subpath" "default" "." ) | nindent 2 }}
---

{{- end }} # range component
{{- end }} # if project.enabled
{{- end }} # range
{{- end }} # if apps
