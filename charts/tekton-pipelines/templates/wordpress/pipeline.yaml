{{ if .Values.wordpress.enabled }}
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: wordpress-build-pipeline
  namespace: {{ .Release.Namespace }}
  labels:
    tekton: 'true'
spec:
  description: >-
    Pipeline will trigger redeployments of the POD of the deployment managed by the bitnami wordpress HELM
    chart.

  params:
    {{ include "pipeline.defaultParams" . | nindent 4 }}

    - name: component_name
      type: string
      description: component name

    - name: kubernetes_namespace
      type: string
      description: kubernetes namespace where wordpress is installed that requires POD redeployment

    - name: gitRevision
      type: string
      description: git branch/tag to deploy
      default: develop

    - name: kubernetes_repository_ssh_url
      type: string
      description: git repository ssh url for kubernetes manifests repo

    - name: kubernetes_branch
      type: string
      description: branch in kubernetes repo to update
      default: main

    - name: kustomization_path
      type: string
      description: path to kustomization.yaml in kubernetes repo
      default: "apps/wordpress/staging/kustomization.yaml"

  workspaces:
    - name: source

  tasks:
    - name: git-clone-gitops-repository
      taskRef:
        name: git-clone
      params:
        - name: url
          value: $(params.kubernetes_repository_ssh_url)
        - name: revision
          value: $(params.kubernetes_branch)
        - name: subdirectory
          value: gitops
      workspaces:
        - name: output
          workspace: source

    - name: update-wordpress-kustomization
      taskRef:
        name: update-wordpress-kustomization
      params:
        - name: application
          value: "$(params.application)"
        - name: component_name
          value: "$(params.component_name)"
        - name: wordpress_branch
          value: "$(params.gitRevision)"
        - name: wordpress_commit_sha
          value: "$(params.sha)"
        - name: kubernetes_namespace
          value: "$(params.kubernetes_namespace)"
        - name: kustomization_path
          value: "$(params.kustomization_path)"
        - name: kubernetes_branch
          value: "$(params.kubernetes_branch)"
        - name: environment
          value: "$(params.environment)"
        - name: subdirectory
          value: gitops
      workspaces:
        - name: source
          workspace: source
      runAfter:
        - git-clone-gitops-repository

    - name: update-values-yaml
      taskRef:
        name: update-values-yaml-repository-revision
      params:
        - name: project
          value: "$(params.project)"
        - name: component
          value: "$(params.component)"
        - name: repositoryRevision
          value: "$(params.gitRevision)"
        - name: kubernetes_branch
          value: "$(params.kubernetes_branch)"
      workspaces:
        - name: source
          workspace: source
      runAfter:
        - update-wordpress-kustomization

    - name: argocd-sync
      taskRef:
        name: argocd-deploy
      params:
        - name: application
          value: "$(params.application)"
        - name: revision
          value: "HEAD"
      runAfter:
        - update-values-yaml

    - name: rollout-restart
      taskRef:
        name: redeploy
      params:
        - name: application
          value: "$(params.application)"
        - name: kubernetes_namespace
          value: "$(params.kubernetes_namespace)"
      runAfter:
        - argocd-sync

  finally:
    - name: slack-notification
      taskRef:
        name: slack-notification
      params:
        - name: application
          value: "$(params.application)"
        - name: sha
          value: "$(params.sha)"
        - name: head_commit
          value: "$(params.head_commit)"
        - name: head_commit_message
          value: "$(params.head_commit_message)"
        - name: pusher_name
          value: "$(params.pusher_name)"
        - name: pusher_email
          value: "$(params.pusher_email)"
        - name: pusher_avatar
          value: "$(params.pusher_avatar)"
        - name: pusher_url
          value: "$(params.pusher_url)"
        - name: repository_url
          value: "$(params.repository_url)"
        - name: branch
          value: "$(params.branch)"
        - name: environment
          value: "$(params.environment)"
        - name: status
          value: "$(tasks.rollout-restart.status)"

{{ end }}
