apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: update-values-yaml-repository-revision
  namespace: {{ .Release.Namespace }}
spec:
  description: Update repositoryRevision in values.yaml and commit to Git
  params:
    - name: project
      type: string
      description: Project name (e.g., aaoa-staging)
    - name: component
      type: string
      description: Component name (e.g., wordpress)
    - name: repositoryRevision
      type: string
      description: Git branch/tag to set
    - name: kubernetes_branch
      type: string
      description: Kubernetes repo branch to commit to
  workspaces:
    - name: source
      description: Workspace with kubernetes repository
  steps:
    - name: update-values
      image: alpine/git:latest
      script: |
        #!/bin/sh
        set -e
        
        PROJECT="$(params.project)"
        COMPONENT="$(params.component)"
        REVISION="$(params.repositoryRevision)"
        BRANCH="$(params.kubernetes_branch)"
        
        echo "Updating repositoryRevision to: $REVISION"
        echo "Project: $PROJECT, Component: $COMPONENT"
        
        # Change to workspace directory
        cd $(workspaces.source.path)/gitops
        
        # Fix git ownership issue
        git config --global --add safe.directory $(workspaces.source.path)/gitops
        
        # Install yq
        wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        chmod +x /usr/local/bin/yq
        
        # Find values.yaml path
        VALUES_FILE="staging/argocd/apps/values.yaml"
        
        if [ ! -f "$VALUES_FILE" ]; then
          echo "ERROR: $VALUES_FILE not found"
          ls -la staging/argocd/apps/ || echo "Directory not found"
          exit 1
        fi
        
        # Update repositoryRevision for the specific project/component
        # Path: .apps[].components[].wordpress.repositoryRevision
        yq eval "(.apps[] | select(.project == \"$PROJECT\") | .components[] | select(.name == \"$COMPONENT\") | .wordpress.repositoryRevision) = \"$REVISION\"" -i "$VALUES_FILE"
        
        # Check if anything changed
        if git diff --quiet "$VALUES_FILE"; then
          echo "No changes needed in $VALUES_FILE"
          exit 0
        fi
        
        # Show diff
        echo "Changes made:"
        git diff "$VALUES_FILE"
        
        # Commit and push
        git config user.name "Tekton Pipeline"
        git config user.email "tekton@saritasa.com"
        git add "$VALUES_FILE"
        git commit -m "chore: update $PROJECT $COMPONENT repositoryRevision to $REVISION"
        git push origin "HEAD:$BRANCH"
        
        echo "Successfully updated and pushed $VALUES_FILE"
