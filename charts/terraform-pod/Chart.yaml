apiVersion: v2
name: terraform-pod

type: application

# This is the chart version. This version number should be incremented each time you make changes
# to the chart and its templates, including the app version.
# Versions are expected to follow Semantic Versioning (https://semver.org/)
version: 0.0.5

maintainers:
  - url: https://www.saritasa.com/
    name: Saritasa

# This is the version number of the application being deployed. This version number should be
# incremented each time you make changes to the application. Versions are not expected to
# follow Semantic Versioning. They should reflect the version the application is using.
# It is recommended to use it with quotes.
appVersion: "1.3.5"

description: |
  A Helm chart for running infra-dev-aws solutions

  ## Install the chart

  Install the chart:

  ```
  helm repo add saritasa https://saritasa-nest.github.io/saritasa-devops-helm-charts/
  ```

  ## Use

  ### Simple case (infra-dev-aws)

  ```sh
  helm upgrade --install CLIENT saritasa/terraform-pod \
    --namespace terraform \
    --set terraform.client=CLIENT \
    --set image.tag=1.3.5 \
    --set github.repository=saritasa-nest/CLIENT-infra-dev-aws \
    --set github.branch=feature/branch \
    --set github.username=YOUR-GITHUB-USERNAME \
    --set github.email=YOUR-GITHUB-EMAIL \
    --set gitCryptKey=$(base64 -w 0 git-crypt-key) \
    --wait
  ```

  ### Passing aws-vault short-term credentials

  (
    creds=aws-vault exec saritasa/v2/administrators --json && \
    helm upgrade --install CLIENT saritasa/terraform-pod \
      --namespace terraform \
      --set terraform.client=CLIENT \
      --set image.tag=1.3.5 \
      --set github.repository=saritasa-nest/CLIENT-infra-aws \
      --set github.branch=feature/branch \
      --set github.username=YOUR-GITHUB-USERNAME \
      --set github.email=YOUR-GITHUB-EMAIL \
      --set gitCryptKey=$(base64 -w 0 git-crypt-key) \
      --set terraform.token=xxx \
      --set aws.accessKeyId=YOUR_IAM_ACCESS_KEY \
      --set aws.secretAccessKey=YOUR_IAM_SECRET_KEY \
      --set terraform.initCommand="make _staging init" \
      --wait && \
    unset creds
  )

  Run command as shown in `()`` so that creds are not exported in your local shell.

  ## Get in the pod

  ```sh
  k exec -ti $(kgpo -l app.kubernetes.io/name=terraform-pod --no-headers -o="custom-columns=NAME:.metadata.name") -c terraform -- bash
  klo $(kgpo -l app.kubernetes.io/name=terraform-pod --no-headers -o="custom-columns=NAME:.metadata.name") --all-containers
  make _dev apply
  ```

  ## Terminate

  ```sh
  helm delete CLIENT
  ````
